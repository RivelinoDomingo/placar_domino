    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Placar do Domin√≥ v2.0 (Integrado)</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
        <style>
            body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
            .font-condensed { font-family: 'Roboto Condensed', sans-serif; }
            .view { display: none; }
            .view.active { display: block; }
            .admin-fab-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; }
            .admin-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #1f2937; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .admin-fab:hover { transform: scale(1.1); background-color: #374151; }
            .admin-fab.active { transform: rotate(45deg); }
            .admin-actions { position: absolute; bottom: 80px; right: 0; background-color: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 1.5rem; width: 300px; transform-origin: bottom right; transform: scale(0.9) translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .admin-actions.active { transform: scale(1) translateY(0); opacity: 1; visibility: visible; }
            .achievement-icon { font-size: 1.5rem; filter: grayscale(80%); opacity: 0.4; transition: all 0.3s; }
            .achievement-icon.unlocked { filter: grayscale(0%); opacity: 1; }
            .player-name-clickable { cursor: pointer; transition: color 0.2s; }
            .player-name-clickable:hover { color: #2563eb; }
            .mesa-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; grid-template-rows: 1fr 2fr 1fr; grid-template-areas: ". top ." "left middle right" ". bottom ."; aspect-ratio: 1.5 / 1; width: 100%; max-width: 800px; }
            .player-slot-top { grid-area: top; }
            .player-slot-left { grid-area: left; }
            .player-slot-right { grid-area: right; }
            .player-slot-bottom { grid-area: bottom; }
            .fade-in { animation: fadeIn 0.5s ease-in-out; }
            @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
            .point-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s ease; }
            .team-legend { transition: opacity 0.3s ease-in-out; }
        </style>
    </head>
    <body class="text-gray-800">

        <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">

            <div id="view-scoreboard" class="view active fade-in">
                <div class="text-center mb-8"><h1 class="text-4xl font-bold font-condensed tracking-wider">PLACAR DO DOMIN√ì</h1></div>
                <div class="flex justify-center mb-12"><button id="btnGoToGameMode" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"><span class="text-2xl mr-3">üÄÑ</span> Iniciar Modo Partida</button></div>
                <div id="playersList" class="space-y-3"><div class="text-center text-gray-500 p-8">Carregando placar...</div></div>
                <div class="mt-10"><h2 class="text-xl font-bold text-gray-700 mb-3">√öltimas Atividades</h2><div id="activityFeed" class="space-y-2 bg-white p-4 rounded-xl shadow-sm"><p class="text-gray-500 text-center">Carregando atividades...</p></div></div>
            </div>

            <!-- This is the message box for success/error/info. It is now fixed at the top. -->
            <div id="messageBox" class="message-box"></div>

            <div id="view-game-table" class="view fade-in">
                <div class="flex justify-between items-center mb-6">
                    <button id="btnBackToScoreboard" class="text-gray-500 hover:text-gray-800 transition">‚Üê Voltar ao Placar</button>
                    <div class="text-center"><h2 class="text-3xl font-bold font-condensed">MODO PARTIDA</h2><p id="gameStatusText" class="text-gray-500">Selecione os jogadores para come√ßar</p></div>
                    <div class="w-24"></div>
                </div>
                <div id="game-type-selector" class="flex justify-center gap-4 mb-4"><button data-mode="individual" class="gameModeBtn font-semibold py-2 px-4 rounded-lg shadow">Individual</button><button data-mode="duplas" class="gameModeBtn font-semibold py-2 px-4 rounded-lg">Duplas</button></div>
                <div id="raio-mode-selector" class="flex justify-center items-center gap-2 mb-6"><input type="checkbox" id="raioModeCheckbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"><label for="raioModeCheckbox" class="font-semibold text-gray-700 cursor-pointer select-none">Partida de Raio ‚ö°Ô∏è</label></div>
                <div class="bg-green-800 border-8 border-yellow-800/50 rounded-2xl shadow-2xl p-4 sm:p-8 mesa-grid mx-auto">
                    <div class="flex items-center justify-center player-slot-top"><div id="slot-1" class="player-slot flex flex-col items-center"></div></div>
                    <div class="flex items-center justify-center player-slot-left"><div id="slot-4" class="player-slot flex flex-col items-center"></div></div>
                    <div class="bg-green-700/80 rounded-full flex items-center justify-center"><span class="text-5xl text-white/50 font-condensed">üÄÑ</span></div>
                    <div class="flex items-center justify-center player-slot-right"><div id="slot-2" class="player-slot flex flex-col items-center"></div></div>
                    <div class="flex items-center justify-center player-slot-bottom"><div id="slot-3" class="player-slot flex flex-col items-center"></div></div>
                </div>
                <div class="mt-8 text-center space-y-4">
                    <button id="btnStartGame" class="bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-not-allowed" disabled>Iniciar Jogo</button>
                    <div id="activeGameButtons" class="hidden flex-wrap justify-center gap-4"><button id="btnLaunchScore" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Lan√ßar Ponto</button><button id="btnUndoRound" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Desfazer</button><button id="btnEndGame" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Encerrar Partida</button></div>
                </div>
            </div>

            <div id="view-game-over" class="view fade-in text-center">
                <h2 class="text-2xl text-gray-600">Fim de Jogo</h2>
                <p id="gameOverWinnerText" class="text-5xl font-bold font-condensed my-4 text-blue-600"></p>
                <p id="gameOverScoreText" class="text-xl text-gray-500 mb-8"></p>
                <div class="flex justify-center gap-4 flex-wrap">
                    <button id="btnShareWhatsapp" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-600 transition flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg> Compartilhar</button>
                    <button id="btnNewGame" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">üÄÑ Nova Partida</button><button id="btnBackToScoreboard_GameOver" class="bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-600 transition">‚Üê Voltar ao Placar</button>
                </div>
            </div>
        </div>

        <div class="admin-fab-container"><div id="adminActionsPanel" class="admin-actions"><h3 class="font-bold text-lg mb-4 text-gray-800">Painel do Administrador</h3><div id="adminLoginView"><p class="text-sm text-gray-600 mb-2">Insira a senha para gerenciar.</p><input type="password" id="adminKeyInput" placeholder="Senha de Admin" class="w-full border-gray-300 rounded-md shadow-sm p-2"><button id="activateAdminBtn" class="w-full mt-3 bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700 transition">Ativar</button></div><div id="adminControlsView" class="hidden space-y-3"><button id="addPlayerBtn_fab" class="w-full bg-green-500 text-white font-semibold py-2 rounded-md hover:bg-green-600 transition">Adicionar Novo Jogador</button><button id="resetScoresBtn_fab" class="w-full bg-red-600 text-white font-semibold py-2 rounded-md hover:bg-red-700 transition">Redefinir Placar Geral</button><p id="adminStatus" class="text-center text-sm text-green-600 font-semibold pt-2">Modo Admin Ativado</p></div></div><div id="adminFabButton" class="admin-fab"><svg id="fabIconDefault" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg><svg id="fabIconClose" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="hidden"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div>

        <div id="modalContainer" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50"><div id="modalContent" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md m-auto"></div></div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, orderBy, limit, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBqpkxcl0GkBBHVO8Nxk7UpYd00H4Frklc",
                authDomain: "placar-domino.firebaseapp.com",
                projectId: "placar-domino",
                storageBucket: "placar-domino.firebasestorage.app",
                messagingSenderId: "187178310074",
                appId: "1:187178310074:web:5f56292dea8dc776532583",
                measurementId: "G-BL3W42DJ3M"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            const ADMIN_KEY = 'Domino25';
            const POINTS_TO_COMPLETE_RAIO = 4;
            const appIdentifier = firebaseConfig.appId;

            let appState = { players: {}, activityFeed: [], isAdminMode: false, userId: null, gameState: {}, unsubscribers: [] };

            const playersCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/players`);
            const activityFeedCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/events`);
            const matchesCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/partidas`);

            const ui = {
                views: document.querySelectorAll('.view'),
                messageBox: document.getElementById('messageBox'),
                playersListDiv: document.getElementById('playersList'),
                activityFeedDiv: document.getElementById('activityFeed'),
                adminFab: { button: document.getElementById('adminFabButton'), panel: document.getElementById('adminActionsPanel'), defaultIcon: document.getElementById('fabIconDefault'), closeIcon: document.getElementById('fabIconClose'), loginView: document.getElementById('adminLoginView'), controlsView: document.getElementById('adminControlsView'), keyInput: document.getElementById('adminKeyInput'), activateBtn: document.getElementById('activateAdminBtn'), addPlayerBtn: document.getElementById('addPlayerBtn_fab'), resetBtn: document.getElementById('resetScoresBtn_fab')},
                modal: { container: document.getElementById('modalContainer'), content: document.getElementById('modalContent')},
                gameMode: { goToBtn: document.getElementById('btnGoToGameMode'), backBtn: document.getElementById('btnBackToScoreboard'), modeButtons: document.querySelectorAll('.gameModeBtn'), raioCheckbox: document.getElementById('raioModeCheckbox'), startBtn: document.getElementById('btnStartGame'), activeButtons: document.getElementById('activeGameButtons'), launchScoreBtn: document.getElementById('btnLaunchScore'), undoBtn: document.getElementById('btnUndoRound'), endBtn: document.getElementById('btnEndGame'), newGameBtn: document.getElementById('btnNewGame'), shareBtn: document.getElementById('btnShareWhatsapp'),backToScoreboard_GameOverBtn: document.getElementById('btnBackToScoreboard_GameOver'), statusText: document.getElementById('gameStatusText'), gameOver: { winnerText: document.getElementById('gameOverWinnerText'), scoreText: document.getElementById('gameOverScoreText')}}
            };


            async function startGame() {
                ui.gameMode.startBtn.disabled = true;
                const { gameMode, isRaioMatch, selectedSlots } = appState.gameState;
                const playerIds = Object.values(selectedSlots).filter(Boolean);

                let gameData = {
                    gameMode,
                    isRaioMatch,
                    playerIds,
                    status: 'active',
                    history: [],
                    createdAt: serverTimestamp(),
                    // Inicializa os contadores de pontos E de raios da partida como zero para todos.
                    scores: playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {}),
                    raios: playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {}),
                };

                if (gameMode === 'duplas') {
                    // A l√≥gica de duplas pode ser refinada aqui no futuro, se necess√°rio
                    gameData.teams = {
                        A: { players: [selectedSlots[2], selectedSlots[4]].filter(Boolean), score: 0, raios: 0 },
                        B: { players: [selectedSlots[1], selectedSlots[3]].filter(Boolean), score: 0, raios: 0 }
                    };
                    gameData.turn = selectedSlots[1];
                } else {
                    gameData.turn = playerIds[0];
                }

                try {
                    const gameDocRef = await addDoc(matchesCollectionRef(), gameData);
                    appState.gameState.activeGameId = gameDocRef.id;

                    const unsub = onSnapshot(gameDocRef, (doc) => {
                        if (doc.exists()) {
                            renderActiveGame(doc.data());
                        }
                    });
                    appState.gameState.activeGameListener = unsub;
                    appState.unsubscribers.push(unsub);

                    ui.gameMode.startBtn.style.display = 'none';
                    ui.gameMode.activeButtons.style.display = 'flex';
                    document.getElementById('game-type-selector').style.display = 'none';
                    document.getElementById('raio-mode-selector').style.display = 'none';
                } catch (error) {
                    console.error("Erro ao iniciar o jogo:", error);
                    showMessage("N√£o foi poss√≠vel iniciar o jogo. Tente novamente.", "error");
                    ui.gameMode.startBtn.disabled = false;
                }
            }

            function generateScoreHTML(raiosDaPartida, pontosAtuais, isRaioMatch) {
                // Mostra os raios Ganhos APENAS nesta partida.
                const raiosHTML = Array.from({ length: raiosDaPartida }, () => `<span class="text-2xl" title="Raio da Partida">‚ö°Ô∏è</span>`).join('');

                let pontosHTML = '';
                if (isRaioMatch) {
                    pontosHTML = Array.from({ length: pontosAtuais }, () => `<span class="text-xl" title="Ponto de Raio">‚ö°Ô∏è</span>`).join('');
                } else {
                    pontosHTML = Array.from({ length: pontosAtuais }, () => `<div class="point-dot bg-yellow-400" title="Ponto"></div>`).join('');
                }
                return raiosHTML + pontosHTML;
            }

            function renderActiveGame(gameData) {
                if (gameData.status === 'finished' || gameData.status === 'aborted') {
                    return;
                }

                appState.gameState.activeGame = gameData;
                // Pega os raios e pontos da sess√£o atual, vindos do gameData
                const { gameMode, scores, raios, turn, isRaioMatch } = gameData;
                const turnPlayerName = appState.players[turn]?.name || '';
                ui.gameMode.statusText.textContent = `Vez de ${turnPlayerName}`;

                gameData.playerIds.forEach(playerId => {
                    const slotId = Object.keys(appState.gameState.selectedSlots).find(key => appState.gameState.selectedSlots[key] === playerId);
                    if (slotId) {
                        const scoreDiv = document.getElementById(`score-${slotId}`);
                        if (scoreDiv) {
                            // Passa para a fun√ß√£o de renderiza√ß√£o apenas os dados da partida atual.
                            scoreDiv.innerHTML = generateScoreHTML(raios[playerId] || 0, scores[playerId] || 0, isRaioMatch);
                        }
                    }
                    const slotDiv = document.getElementById(`slot-${slotId}`)?.firstElementChild;
                    if (slotDiv) {
                        slotDiv.style.boxShadow = turn === playerId ? '0 0 15px 3px rgba(59, 130, 246, 0.7)' : '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1)';
                    }
                });
                ui.gameMode.undoBtn.disabled = gameData.history.length === 0;
            }

            async function launchScore() {
                const { gameMode, isRaioMatch } = appState.gameState.activeGame;
                const WINNING_SCORE = isRaioMatch ? 1 : 4;

                // A cria√ß√£o do modal continua a mesma, esta parte est√° correta.
                let modalHTML = `<h3 class="text-2xl font-bold mb-4">Quem venceu a rodada?</h3><div class="space-y-2 max-h-64 overflow-y-auto">`;
                if (gameMode === 'duplas') {
                    const { teams } = appState.gameState.activeGame;
                    modalHTML += `<button class="w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition winner-select-btn" data-team="A">Time A (${teams.A.players.map(id => appState.players[id].name).join(' & ')})</button>`;
                    modalHTML += `<button class="w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition winner-select-btn" data-team="B">Time B (${teams.B.players.map(id => appState.players[id].name).join(' & ')})</button>`;
                } else {
                    const { playerIds } = appState.gameState.activeGame;
                    const players = playerIds.map(id => appState.players[id]);
                    modalHTML += players.map(p => `<button class="w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition winner-select-btn" data-player-id="${p.id}">${p.name}</button>`).join('');
                }
                modalHTML += `</div><button id="modal-cancel-btn" class="mt-6 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full">Cancelar</button>`;
                openModal(modalHTML);

                ui.modal.content.onclick = async (e) => {
                    const target = e.target.closest('.winner-select-btn');
                    if (!target) return;

                    closeModal();
                    const batch = writeBatch(db);
                    const gameDocRef = doc(matchesCollectionRef(), appState.gameState.activeGameId);
                    const currentGame = appState.gameState.activeGame;

                    let updates = { history: [...currentGame.history] };
                    let roundEvent = { timestamp: new Date() };

                    if (gameMode === 'duplas') {
                        // L√≥gica para duplas
                    } else { // MODO INDIVIDUAL
                        const winnerId = target.dataset.playerId;
                        const playerDocRef = doc(playersCollectionRef(), winnerId);
                        const newScore = (currentGame.scores[winnerId] || 0) + 1;
                        roundEvent.winner = winnerId;

                        // --- IN√çCIO DA CORRE√á√ÉO ---
                        // 1. Prepara um objeto √∫nico para todas as atualiza√ß√µes do PERFIL do jogador.
                        const playerUpdates = {
                            vitorias: (appState.players[winnerId].vitorias || 0) + 1
                        };

                        if (newScore >= WINNING_SCORE) {
                            // 2. Se ganhou um raio, adiciona a atualiza√ß√£o de 'raios' AO MESMO objeto.
                            playerUpdates.raios = (appState.players[winnerId].raios || 0) + 1;

                            // Adiciona uma "pista" no hist√≥rico de que esta jogada completou um raio.
                            roundEvent.completedRaio = true;

                            // Prepara as atualiza√ß√µes para o documento da PARTIDA
                            updates[`raios.${winnerId}`] = (currentGame.raios[winnerId] || 0) + 1;
                            updates.scores = currentGame.playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {});
                            updates.turn = winnerId;

                            showMessage(`${appState.players[winnerId].name} ganhou um Raio! ‚ö°Ô∏è`, 'success');
                        } else {
                            // Atualiza os pontos da partida se n√£o ganhou um raio
                            updates.scores = { ...currentGame.scores, [winnerId]: newScore };
                            updates.turn = winnerId;
                        }

                        // 3. Adiciona a instru√ß√£o de atualiza√ß√£o do jogador ao batch UMA √öNICA VEZ.
                        batch.update(playerDocRef, playerUpdates);
                        // --- FIM DA CORRE√á√ÉO ---
                    }

                    updates.history.push(roundEvent);
                    batch.update(gameDocRef, updates);

                    await batch.commit();
                };
            }

            async function undoRound() {
                const currentGame = { ...appState.gameState.activeGame };

                if (currentGame.history.length === 0) {
                    showMessage("Nenhuma jogada para desfazer.", "info");
                    return;
                }

                // --- IN√çCIO DA L√ìGICA CORRIGIDA ---
                const batch = writeBatch(db);
                const gameDocRef = doc(matchesCollectionRef(), appState.gameState.activeGameId);

                // 1. Pega a √∫ltima jogada que ser√° desfeita
                const lastRound = currentGame.history.pop();
                const winnerId = lastRound.winner;

                if (!winnerId) {
                    showMessage("Erro ao desfazer: jogada inv√°lida.", "error");
                    return;
                }

                // 2. Prepara a revers√£o das estat√≠sticas PERMANENTES do jogador
                const playerDocRef = doc(playersCollectionRef(), winnerId);
                const playerUpdates = {
                    // Sempre desfaz uma 'vit√≥ria' de rodada
                    vitorias: (appState.players[winnerId].vitorias || 1) - 1
                };

                // Se a jogada desfeita completou um raio, desfaz o raio tamb√©m
                if (lastRound.completedRaio) {
                    playerUpdates.raios = (appState.players[winnerId].raios || 1) - 1;
                }
                batch.update(playerDocRef, playerUpdates);

                // 3. Prepara a revers√£o dos dados da PARTIDA (recalcula tudo)
                const matchUpdates = { history: currentGame.history };

                // Recalcula os pontos e raios da partida com base no hist√≥rico restante
                let newScores = currentGame.playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {});
                let newRaios = currentGame.playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {});

                matchUpdates.history.forEach(round => {
                    if (round.winner) {
                        newScores[round.winner]++;
                        if (round.completedRaio) {
                            newRaios[round.winner]++;
                            // Zera os pontos pois um raio foi refeito
                            newScores = currentGame.playerIds.reduce((acc, id) => ({ ...acc, [id]: 0 }), {});
                        }
                    }
                });

                matchUpdates.scores = newScores;
                matchUpdates.raios = newRaios;
                matchUpdates.turn = matchUpdates.history.length > 0 ? matchUpdates.history.slice(-1)[0].winner : currentGame.playerIds[0];

                batch.update(gameDocRef, matchUpdates);

                // 4. Executa todas as revers√µes (jogador e partida) de uma vez
                await batch.commit();
                showMessage("√öltima jogada desfeita.", "info");
                // --- FIM DA L√ìGICA CORRIGIDA ---
            }

            async function endGame() {
                const currentGame = appState.gameState.activeGame;

                if (!currentGame || currentGame.history.length === 0) {
                    resetGameState();
                    switchView('view-scoreboard');
                    return;
                }

                const modalHTML = `
                    <h3 class="text-xl font-bold text-red-600">Encerrar Partida</h3>
                    <p class="my-4">Tem certeza que deseja encerrar a partida? O jogador com mais raios (e pontos como desempate) ser√° declarado o vencedor.</p>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="confirmEndNo" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg">N√£o, continuar</button>
                        <button id="confirmEndYes" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Sim, encerrar</button>
                    </div>`;
                openModal(modalHTML);

                document.getElementById('confirmEndYes').onclick = async () => {
                    closeModal();

                    let leaderId = null, leaderTeam = null;
                    let maxRaios = -1, maxPoints = -1, isTie = false;

                    if (currentGame.gameMode === 'duplas') {
                        // L√≥gica de duplas (dando prioridade aos raios)
                        const raiosA = currentGame.teams.A.raios || 0;
                        const raiosB = currentGame.teams.B.raios || 0;

                        if (raiosA > raiosB) { leaderTeam = 'A'; }
                        else if (raiosB > raiosA) { leaderTeam = 'B'; }
                        else { // Raios empatados, usa pontos como desempate
                            const scoreA = currentGame.teams.A.score;
                            const scoreB = currentGame.teams.B.score;
                            if (scoreA > scoreB) { leaderTeam = 'A'; }
                            else if (scoreB > scoreA) { leaderTeam = 'B'; }
                            else { isTie = true; }
                        }
                        maxRaios = Math.max(raiosA, raiosB);
                        maxPoints = Math.max(currentGame.teams.A.score, currentGame.teams.B.score);

                    } else { // MODO INDIVIDUAL
                        // --- IN√çCIO DA L√ìGICA CORRIGIDA ---
                        // Percorre todos os jogadores para encontrar o l√≠der baseado em Raios > Pontos
                        for (const playerId of currentGame.playerIds) {
                            const playerRaios = currentGame.raios[playerId] || 0;
                            const playerPoints = currentGame.scores[playerId] || 0;

                            if (playerRaios > maxRaios) {
                                // Novo l√≠der por ter mais raios
                                maxRaios = playerRaios;
                                maxPoints = playerPoints;
                                leaderId = playerId;
                                isTie = false;
                            } else if (playerRaios === maxRaios) {
                                // Raios empatados, verifica os pontos
                                if (playerPoints > maxPoints) {
                                    // Novo l√≠der pelo desempate de pontos
                                    maxPoints = playerPoints;
                                    leaderId = playerId;
                                    isTie = false;
                                } else if (playerPoints === maxPoints) {
                                    // Empate total
                                    isTie = true;
                                }
                            }
                        }
                    }
                    // --- FIM DA L√ìGICA CORRIGIDA ---

                    // Agora, a condi√ß√£o de vit√≥ria verifica se houve um vencedor (sem empate)
                    // e se ele tem ao menos um raio ou um ponto.
                    if (!isTie && (maxRaios > 0 || maxPoints > 0)) {
                        const winnerInfo = currentGame.gameMode === 'duplas' ? { winnerTeam: leaderTeam } : { winnerId: leaderId };
                        const finalGameData = { ...currentGame, status: 'finished', winnerInfo, maxRaios };
                        await processAndShowGameOver(finalGameData);
                    } else {
                        // Se houver empate ou ningu√©m pontuou, a partida √© abortada.
                        const gameDocRef = doc(matchesCollectionRef(), appState.gameState.activeGameId);
                        await updateDoc(gameDocRef, { status: 'aborted', endedAt: serverTimestamp() });
                        resetGameState();
                        switchView('view-scoreboard');
                        showMessage("Partida encerrada sem vencedor.", "info");
                    }
                };

                document.getElementById('confirmEndNo').onclick = () => closeModal();
            }

            async function processAndShowGameOver(gameData) {
                // Previne execu√ß√µes m√∫ltiplas
                if (document.getElementById('view-game-over').classList.contains('active')) return;

                const { gameMode, winnerInfo, teams, scores, playerIds, isRaioMatch } = gameData;
                const batch = writeBatch(db);
                let winnerText = '';

                if (gameMode === 'duplas') {
                    const winnerTeamName = winnerInfo.winnerTeam === 'A' ? 'Time A' : 'Time B';
                    const winnerPlayers = teams[winnerInfo.winnerTeam].players.map(id => appState.players[id].name);
                    winnerText = `${winnerTeamName} venceu! (${winnerPlayers.join(' & ')})`;
                } else {
                    winnerText = `${appState.players[winnerInfo.winnerId].name} venceu!`;
                }

                const gameDocRef = doc(matchesCollectionRef(), appState.gameState.activeGameId);
                batch.update(gameDocRef, { status: 'finished', endedAt: serverTimestamp(), winnerInfo: winnerInfo });

                for (const playerId of playerIds) {
                    const playerDocRef = doc(playersCollectionRef(), playerId);
                    const player = appState.players[playerId];
                    const updates = { partidasJogadas: (player.partidasJogadas || 0) + 1 };
                    const isWinner = winnerInfo.winnerId === playerId || (teams && teams[winnerInfo.winnerTeam]?.players.includes(playerId));

                    if (!isWinner) {
                        const playerScore = scores ? (scores[playerId] || 0) : 0;
                        if (playerScore === 0 && !isRaioMatch) {
                            updates.lambreta = (player.lambreta || 0) + 1;
                        }
                    }
                    batch.update(playerDocRef, updates);
                }

                await batch.commit();

                // Exibe a tela de Fim de Jogo
                ui.gameMode.gameOver.winnerText.textContent = winnerText;
                const finalScoreText = gameMode === 'duplas' ? `Placar final dos pontos: ${teams.A.score} a ${teams.B.score}` : `Placar final dos pontos: ${Object.values(scores).join(' - ')}`;
                ui.gameMode.gameOver.scoreText.textContent = finalScoreText;

                resetGameState();
                switchView('view-game-over');
            }

            function switchView(viewId) { ui.views.forEach(v => v.classList.toggle('active', v.id === viewId)); }

            function renderScoreboard() {
                const players = Object.values(appState.players);
                const seriesOrder = ['A', 'B', 'C', 'D', 'Amador'];

                players.sort((a, b) => {
                    const seriesIndexA = seriesOrder.indexOf(a.series || 'Amador');
                    const seriesIndexB = seriesOrder.indexOf(b.series || 'Amador');
                    if (seriesIndexA !== seriesIndexB) return seriesIndexA - seriesIndexB;
                    if ((b.raios || 0) !== (a.raios || 0)) return (b.raios || 0) - (a.raios || 0);
                    if ((b.vitorias || 0) !== (a.vitorias || 0)) return (b.vitorias || 0) - (a.vitorias || 0);
                    return (a.lambretas || 0) - (b.lambretas || 0);
                });
                // Configura√ß√£o dos dados do playes da tabela
                ui.playersListDiv.innerHTML = players.map(player => `
                    <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                        <div><span class="font-bold text-lg player-name-clickable" data-player-id="${player.id}">${player.name}</span><span class="text-sm text-gray-500 ml-2">(S√©rie ${player.series})</span></div>
                        <div class="text-right"><div class="font-semibold text-blue-600">Raios: ${player.raios || 0}</div><div class="font-semibold text-yellow-600">Lambretas: ${player.lambreta || 0}</div></div>
                    </div>`).join('');
            }

            function renderActivityFeed() {
                ui.activityFeedDiv.innerHTML = appState.activityFeed.length === 0 ? '<p class="text-gray-500 text-center">Nenhuma atividade recente.</p>' :
                    appState.activityFeed.map(item => {
                        let icon = 'üí¨';
                        if (item.type === 'promotion') icon = '‚ñ≤';
                        else if (item.type === 'demotion') icon = '‚ñº';
                        else if (item.type === 'stagnant') icon = 'üìç';
                        else if (item.type === 'achievement') icon = '‚≠ê';
                        const color = item.type === 'promotion' ? 'green' : (item.type === 'demotion' ? 'red' : 'yellow');
                        const timestamp = item.timestamp?.seconds ? new Date(item.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'agora';
                        return `<div class="p-3 rounded-lg flex items-center gap-3"><span class="text-${color}-500">${icon}</span><div><p class="text-gray-800"><span class="font-semibold">${item.player}</span> ${item.text}</p><p class="text-xs text-gray-400">${timestamp}</p></div></div>`;
                    }).join('');
            }

            function openModal(contentHTML) { ui.modal.content.innerHTML = contentHTML; ui.modal.container.style.display = 'flex'; }
            function closeModal() { ui.modal.container.style.display = 'none'; }

            async function updatePlayerStat(playerId, stat, amount) {
                if (!appState.isAdminMode) return; // Seguran√ßa extra

                const player = appState.players[playerId];
                if (!player) return;

                const currentValue = player[stat] || 0;
                // Impede que o valor se torne negativo
                if (currentValue + amount < 0) {
                    showMessage(`N√£o √© poss√≠vel ter valor negativo para ${stat}.`, 'error');
                    return;
                }

                const playerDocRef = doc(playersCollectionRef(), playerId);
                try {
                    // Usa a fun√ß√£o 'increment' do Firestore para uma atualiza√ß√£o segura
                    await updateDoc(playerDocRef, {
                        [stat]: increment(amount)
                    });
                    // N√£o √© necess√°rio mostrar mensagem de sucesso para n√£o poluir a tela.
                } catch (error) {
                    console.error(`Erro ao atualizar ${stat}:`, error);
                    showMessage(`Erro ao atualizar ${stat}.`, 'error');
                }
            }

            // Fun√ß√£o da caixa de estatistica dos jogadores (CORRIGIDA)
            function openPlayerDetailsModal(playerId) {
                const player = appState.players[playerId];
                if (!player) return;

                const generateStatControlHTML = (stat, label) => {
                    const value = player[stat] || 0;
                    if (!appState.isAdminMode) {
                        return `<div class="bg-gray-100 p-3 rounded-lg"><p class="text-2xl font-bold">${value}</p><p class="text-sm text-gray-500">${label}</p></div>`;
                    }
                    return `
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2 font-semibold">${label}</p>
                            <div class="flex items-center justify-center gap-3">
                                <button data-action="decrement" data-stat="${stat}" class="stat-button h-8 w-8 rounded-full bg-red-200 text-red-700 font-bold text-xl hover:bg-red-300 transition flex items-center justify-center">-</button>
                                <p id="${stat}-value" class="text-2xl font-bold w-10 text-center">${value}</p>
                                <button data-action="increment" data-stat="${stat}" class="stat-button h-8 w-8 rounded-full bg-green-200 text-green-700 font-bold text-xl hover:bg-green-300 transition flex items-center justify-center">+</button>
                            </div>
                        </div>`;
                };

                const statsHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        ${generateStatControlHTML('raios', 'Raios')}
                        <div class="bg-gray-100 p-3 rounded-lg"><p class="text-sm text-gray-500 mb-2 font-semibold">Vit√≥rias</p><p class="text-2xl font-bold">${player.vitorias || 0}</p></div>
                        ${generateStatControlHTML('lambreta', 'Lambretas')}
                    </div>
                `;

                const achievements = {
                    primeiro_rei: { icon: 'üëë', name: 'Primeiro Rei', description: 'Chegou ao topo da S√©rie A.' },
                    imbativel: { icon: 'üî•', name: 'Imbat√≠vel', description: 'Venceu 3 partidas consecutivas.' },
                    azarao: { icon: 'üöë', name: 'Azar√£o', description: 'Acumulou 3 lambretas seguidas.' },
                };
                let achievementsHTML = Object.keys(achievements).map(key => {
                    const ach = achievements[key];
                    const unlocked = player.conquistas?.includes(key);
                    return `<div class="text-center p-2 rounded-lg ${unlocked ? 'bg-yellow-100' : 'bg-gray-100'}"><span class="achievement-icon ${unlocked ? 'unlocked' : ''}" title="${ach.name}: ${ach.description}">${ach.icon}</span><p class="text-xs font-semibold mt-1 ${unlocked ? 'text-yellow-800' : 'text-gray-500'}">${ach.name}</p></div>`;
                }).join('');

                // --- LINHA CORRIGIDA COM AS CLASSES DE ESTILO RESTAURADAS ---
                let adminControlsHTML = appState.isAdminMode ? `
                    <hr class="my-6">
                    <div class="flex justify-around gap-4">
                        <button id="btnRenamePlayer" class="flex-grow bg-gray-200 text-gray-800 font-semibold py-3 px-3 rounded-lg hover:bg-gray-300 transition">Renomear</button>
                        <button id="btnDeletePlayer" class="flex-grow bg-red-600 text-white font-semibold py-3 px-3 rounded-lg hover:bg-red-700 transition">Deletar</button>
                    </div>` : '';

                // Monta o HTML final do modal
                const modalHTML = `
                    <div class="flex justify-between items-start">
                        <div><h3 class="text-2xl font-bold">${player.name}</h3><p class="text-gray-600">S√©rie ${player.series}</p></div>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="mt-6"><h4 class="font-semibold mb-2">Estat√≠sticas</h4>${statsHTML}</div>
                    <div class="mt-6"><h4 class="font-semibold mb-2">Conquistas</h4><div class="grid grid-cols-3 gap-2">${achievementsHTML}</div></div>
                    ${adminControlsHTML}`;

                openModal(modalHTML);

                if (appState.isAdminMode) {
                    const statsContainer = document.querySelector('#modalContent');
                    statsContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.stat-button');
                        if (!button) return;
                        const { action, stat } = button.dataset;
                        const amount = action === 'increment' ? 1 : -1;
                        const valueElement = document.getElementById(`${stat}-value`);
                        const currentValue = parseInt(valueElement.textContent, 10);
                        const newValue = currentValue + amount;
                        if (newValue >= 0) {
                            valueElement.textContent = newValue;
                            updatePlayerStat(playerId, stat, amount);
                        } else {
                            showMessage(`N√£o √© poss√≠vel ter valor negativo.`, 'error');
                        }
                    });

                    const renameBtn = document.getElementById('btnRenamePlayer');
                    const deleteBtn = document.getElementById('btnDeletePlayer');
                    if (renameBtn) renameBtn.addEventListener('click', () => renomearJogador(playerId));
                    if (deleteBtn) deleteBtn.addEventListener('click', () => deletarJogador(playerId));
                }
            }

            function createInitialGameState() { return { gameMode: 'individual', isRaioMatch: false, selectedSlots: { 1: null, 2: null, 3: null, 4: null }, activeGame: null, activeGameId: null, activeGameListener: null }; }

            function resetGameState() {
                if (appState.gameState.activeGameListener) {
                    appState.gameState.activeGameListener();
                }
                appState.gameState = createInitialGameState();
                ui.gameMode.statusText.textContent = 'Selecione os jogadores para come√ßar';
                ui.gameMode.startBtn.style.display = 'block';
                ui.gameMode.activeButtons.style.display = 'none';
                document.getElementById('game-type-selector').style.display = 'flex';
                document.getElementById('raio-mode-selector').style.display = 'flex';
                ui.gameMode.raioCheckbox.checked = false;
                updateGameModeUI();
            }

            function updateGameModeUI() {
                ui.gameMode.modeButtons.forEach(btn => btn.className = `gameModeBtn font-semibold py-2 px-4 rounded-lg ${btn.dataset.mode === appState.gameState.gameMode ? 'shadow bg-blue-500 text-white' : 'bg-white text-gray-500'}`);
                resetPlayerSlots();
            }

            function resetPlayerSlots() {
                appState.gameState.selectedSlots = { 1: null, 2: null, 3: null, 4: null };
                renderAllSlots();
            }

            function renderAllSlots() {
                document.querySelectorAll('.player-slot').forEach(slot => renderPlayerSlot(slot.id.split('-')[1]));
                checkStartGameCondition();
            }

            function renderPlayerSlot(slotId) {
                const slotDiv = document.getElementById(`slot-${slotId}`);
                const playerId = appState.gameState.selectedSlots[slotId];
                const player = playerId ? appState.players[playerId] : null;

                slotDiv.innerHTML = '';
                if (player) {
                    let teamIndicator = '';
                    if (appState.gameState.gameMode === 'duplas') {
                        let teamName = (['2', '4'].includes(String(slotId))) ? 'Time A' : 'Time B';
                        let teamColor = (teamName === 'Time A') ? 'bg-blue-200 text-blue-800' : 'bg-red-200 text-red-800';
                        teamIndicator = `<div class="text-xs font-bold px-2 py-0.5 rounded-full ${teamColor}">${teamName}</div>`;
                    }
                    slotDiv.innerHTML = `<div class="bg-white p-3 rounded-lg shadow-md text-center w-32 sm:w-40 transition-all transform hover:scale-105 cursor-pointer" data-slot-id="${slotId}"><div class="font-bold text-lg truncate">${player.name}</div><div class="text-sm text-gray-500 mb-2">S√©rie ${player.series}</div>${teamIndicator}<div id="score-${slotId}" class="flex flex-wrap justify-center items-center gap-2 mt-2 h-auto min-h-[20px] text-2xl"></div></div>`;
                    slotDiv.querySelector(`[data-slot-id="${slotId}"]`).addEventListener('click', () => openPlayerSelectionModal(slotId));
                } else {
                    let legendHTML = '';
                    if (appState.gameState.gameMode === 'duplas') {
                        legendHTML = `<div class="team-legend text-${(['2', '4'].includes(String(slotId)) ? 'blue' : 'red')}-300 text-xs mt-1 font-semibold">${(['2', '4'].includes(String(slotId)) ? 'Time A' : 'Time B')}</div>`;
                    }
                    slotDiv.innerHTML = `<button class="add-player-btn w-20 h-20 bg-white/20 rounded-full flex items-center justify-center text-4xl text-white/50 hover:bg-white/40 transition" data-slot-id="${slotId}">+</button>${legendHTML}`;
                    slotDiv.querySelector('.add-player-btn').addEventListener('click', () => openPlayerSelectionModal(slotId));
                }
            }

            function openPlayerSelectionModal(slotId) {
                if (appState.gameState.activeGame) return;
                appState.gameState.targetSlot = slotId;
                const availablePlayers = Object.values(appState.players).filter(p => !Object.values(appState.gameState.selectedSlots).includes(p.id));
                const modalHTML = `<h3 class="text-2xl font-bold mb-4">Selecione um Jogador</h3><div class="space-y-2 max-h-64 overflow-y-auto">${availablePlayers.map(p => `<button class="w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition player-select-btn" data-player-id="${p.id}">${p.name}</button>`).join('')}</div><button id="modal-cancel-btn" class="mt-6 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full">Cancelar</button>`;
                openModal(modalHTML);
            }

            function selectPlayer(playerId) {
                const currentSlotOfPlayer = Object.keys(appState.gameState.selectedSlots).find(key => appState.gameState.selectedSlots[key] === playerId);
                if (currentSlotOfPlayer) appState.gameState.selectedSlots[currentSlotOfPlayer] = null;
                appState.gameState.selectedSlots[appState.gameState.targetSlot] = playerId;
                closeModal();
                renderAllSlots();
            }

            function checkStartGameCondition() {
                const selectedCount = Object.values(appState.gameState.selectedSlots).filter(Boolean).length;
                const canStart = (appState.gameState.gameMode === 'duplas') ? (selectedCount === 4) : (selectedCount >= 2);
                ui.gameMode.startBtn.disabled = !canStart;
                ui.gameMode.startBtn.className = canStart ? 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition' : 'bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-not-allowed';
            }

            // Vers√£o Aprimorada da fun√ß√£o showMessage
            function showMessage(message, type = 'info', contentElement = null) {
                const messageBox = ui.messageBox;

                // Limpa qualquer notifica√ß√£o anterior para evitar sobreposi√ß√£o
                if (messageBox.closeTimer) {
                    clearTimeout(messageBox.closeTimer);
                }
                closeMessageBox(true); // 'true' para um fechamento instant√¢neo

                // Mant√©m a funcionalidade de MODAL que existia antes, para n√£o quebrar nada
                if (contentElement) {
                    messageBox.innerHTML = ''; // Limpa o conte√∫do
                    messageBox.className = 'message-box modal-active'; // Usa uma classe para identificar o modo modal
                    messageBox.appendChild(contentElement);
                    Object.assign(messageBox.style, {
                        position: 'fixed', top: '0', left: '0', transform: 'none',
                        width: '100%', height: '100%', backgroundColor: 'rgba(0, 0, 0, 0.6)',
                        display: 'flex', justifyContent: 'center', alignItems: 'center',
                        zIndex: '1000', padding: '20px', borderRadius: '0', boxShadow: 'none'
                    });
                    messageBox.style.display = 'flex';
                    return; // Encerra a fun√ß√£o aqui para o modo modal
                }

                // L√≥gica para as NOTIFICA√á√ïES (banner no topo)
                let baseClasses = 'fixed left-1/2 -translate-x-1/2 w-auto min-w-[320px] max-w-[90%] py-3 px-5 rounded-lg shadow-2xl text-white font-semibold z-[1002] transition-all duration-500 ease-in-out';
                let typeClasses = '';

                // Define a cor de fundo com base no tipo da mensagem
                switch (type) {
                    case 'success':
                        typeClasses = 'bg-green-600'; // Verde para sucesso
                        break;
                    case 'error':
                        typeClasses = 'bg-red-600'; // Vermelho para erro
                        break;
                    default: // 'info'
                        typeClasses = 'bg-blue-600'; // Azul para informa√ß√µes gerais
                        break;
                }

                messageBox.className = `${baseClasses} ${typeClasses} -top-24`; // Come√ßa fora da tela
                messageBox.textContent = message;
                messageBox.style.display = 'block';

                // Anima√ß√£o de entrada: desliza para dentro da tela
                setTimeout(() => {
                    messageBox.classList.remove('-top-24');
                    messageBox.classList.add('top-5');
                }, 50); // Pequeno delay para garantir que a transi√ß√£o CSS seja acionada

                // Agenda o fechamento autom√°tico da notifica√ß√£o
                messageBox.closeTimer = setTimeout(() => {
                    closeMessageBox();
                }, 4000); // A mensagem ficar√° vis√≠vel por 4 segundos
            }
            // Vers√£o Aprimorada da fun√ß√£o closeMessageBox
            function closeMessageBox(instant = false) {
                const messageBox = ui.messageBox;

                // Se for um modal, apenas esconde
                if (messageBox.classList.contains('modal-active')) {
                    messageBox.style.display = 'none';
                    messageBox.innerHTML = '';
                    messageBox.className = 'message-box';
                    return;
                }

                // Se for para fechar instantaneamente (sem anima√ß√£o)
                if (instant) {
                    messageBox.style.display = 'none';
                    messageBox.className = 'message-box';
                    return;
                }

                // Anima√ß√£o de sa√≠da para notifica√ß√µes: desliza para fora da tela
                messageBox.classList.remove('top-5');
                messageBox.classList.add('-top-24');

                // Ap√≥s a anima√ß√£o, oculta o elemento e reseta suas classes
                setTimeout(() => {
                    // Verifica√ß√£o para garantir que n√£o estamos alterando uma notifica√ß√£o que j√° foi fechada
                    if (!messageBox.classList.contains('top-5')) {
                       messageBox.style.display = 'none';
                       messageBox.className = 'message-box';
                    }
                }, 500); // Dura√ß√£o da transi√ß√£o CSS
            }

            async function addNovoJogador() {
                if (!appState.isAdminMode) {
                    showMessage("Voc√™ precisa estar no Modo Administrador para adicionar jogadores.", 'error');
                    return;
                }

                // 1. Construir o HTML do modal usando as classes TailwindCSS do seu projeto.
                const modalHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-2xl font-bold">Adicionar Novo Jogador</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="mt-4">
                        <label for="newPlayerNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nome do Jogador</label>
                        <input type="text" id="newPlayerNameInput" placeholder="Digite o nome aqui" class="w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancelAddPlayerBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button id="saveAddPlayerBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Adicionar Jogador</button>
                    </div>
                `;

                // 2. Abrir o modal padr√£o da aplica√ß√£o com o conte√∫do criado.
                openModal(modalHTML);

                const newPlayerNameInput = document.getElementById('newPlayerNameInput');
                newPlayerNameInput.focus(); // Foco autom√°tico no campo de input.

                // 3. Adicionar os event listeners para os novos bot√µes dentro do modal.
                document.getElementById('saveAddPlayerBtn').onclick = async () => {
                    const newName = newPlayerNameInput.value.trim();
                    if (newName) {
                        try {
                            await addDoc(playersCollectionRef(), {
                                name: newName,
                                raios: 0,
                                vitorias: 0,
                                lambreta: 0,
                                series: 'Amador',
                                conquistas: [] // Adicionado para consist√™ncia
                            });
                            // A fun√ß√£o showMessage continua sendo usada para feedback r√°pido no topo da tela.
                            showMessage(`Jogador "${newName}" adicionado com sucesso!`, 'success');
                            closeModal(); // Fecha o modal ap√≥s o sucesso.
                        } catch (error) {
                            console.error("Erro ao adicionar jogador:", error);
                            showMessage("Erro ao adicionar jogador. Tente novamente.", 'error');
                        }
                    } else {
                        showMessage("O nome do jogador n√£o pode ser vazio.", 'error');
                    }
                };

                // O bot√£o de cancelar agora tamb√©m usa a fun√ß√£o padr√£o de fechar.
                document.getElementById('cancelAddPlayerBtn').onclick = () => {
                    closeModal();
                };
            }

            async function renomearJogador(playerId) {
                if (!appState.isAdminMode) {
                    showMessage("A√ß√£o n√£o permitida.", 'error');
                    return;
                }
                const player = appState.players[playerId];
                const playerDocRef = doc(playersCollectionRef(), playerId);

                // Usa o sistema de modal padr√£o
                const modalHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-2xl font-bold">Renomear Jogador</h3>
                        <button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="mt-4">
                        <label for="reNamePlayerInput" class="block text-sm font-medium text-gray-700 mb-1">Novo nome para ${player.name}</label>
                        <input type="text" id="reNamePlayerInput" value="${player.name}" class="w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="cancelRenamePlayerBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                        <button id="saveRenamePlayerBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Salvar Altera√ß√µes</button>
                    </div>`;
                openModal(modalHTML);

                const reNamePlayerInput = document.getElementById('reNamePlayerInput');
                reNamePlayerInput.focus();
                reNamePlayerInput.select();

                document.getElementById('saveRenamePlayerBtn').onclick = async () => {
                    const newName = reNamePlayerInput.value.trim();
                    if (newName && newName !== player.name) {
                        try {
                            await updateDoc(playerDocRef, { name: newName });
                            showMessage(`Jogador renomeado para "${newName}".`, 'success');
                            closeModal();
                        } catch (error) {
                            console.error("Erro ao renomear jogador:", error);
                            showMessage("Erro ao renomear jogador. Tente novamente.", 'error');
                        }
                    } else if (newName === player.name) {
                        closeModal(); // Apenas fecha se o nome for o mesmo
                    } else {
                        showMessage("O nome n√£o pode ser vazio.", 'error');
                    }
                };
                document.getElementById('cancelRenamePlayerBtn').onclick = () => closeModal();
            }

            async function deletarJogador(playerId) {
                if (!appState.isAdminMode) {
                    showMessage("A√ß√£o n√£o permitida.", 'error');
                    return;
                }
                const player = appState.players[playerId];
                const playerDocRef = doc(playersCollectionRef(), playerId);

                // Modal de confirma√ß√£o usando o sistema padr√£o
                const modalHTML = `
                    <h3 class="text-xl font-bold text-red-600">Confirmar Exclus√£o</h3>
                    <p class="my-4">Tem certeza que deseja remover permanentemente o jogador <strong>${player.name}</strong>? Esta a√ß√£o n√£o pode ser desfeita.</p>
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="confirmDeleteNo" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition">N√£o, cancelar</button>
                        <button id="confirmDeleteYes" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Sim, deletar</button>
                    </div>`;
                openModal(modalHTML);

                document.getElementById('confirmDeleteYes').onclick = async () => {
                    try {
                        await deleteDoc(playerDocRef);
                        closeModal();
                        showMessage(`Jogador "${player.name}" removido com sucesso!`, 'success');
                        // Opcional: registrar evento de remo√ß√£o no feed de atividades
                        // await addDoc(activityFeedCollectionRef(), { type: 'removal', player: player.name, text: 'foi removido do placar.', timestamp: serverTimestamp() });
                    } catch (error) {
                        showMessage("Erro ao remover jogador.", 'error');
                        console.error("Erro ao deletar: ", error);
                    }
                };
                document.getElementById('confirmDeleteNo').onclick = () => closeModal();
            }

            // Ativa√ß√£o do modo admin
            function toggleAdminPanel() { ui.adminFab.button.classList.toggle('active'); ui.adminFab.defaultIcon.classList.toggle('hidden'); ui.adminFab.closeIcon.classList.toggle('hidden'); ui.adminFab.panel.classList.toggle('active'); if (!ui.adminFab.panel.classList.contains('active') && !appState.isAdminMode) { ui.adminFab.loginView.style.display = 'block'; ui.adminFab.controlsView.style.display = 'none'; ui.adminFab.keyInput.value = ''; }}
            function activateAdminMode() { if(ui.adminFab.keyInput.value === ADMIN_KEY) { appState.isAdminMode = true; ui.adminFab.loginView.style.display = 'none'; ui.adminFab.controlsView.style.display = 'block'; } else { alert('Senha incorreta!'); }}

            function setupFirestoreListeners() {
                appState.unsubscribers.forEach(unsub => unsub());
                appState.unsubscribers = [];

                const unsubPlayers = onSnapshot(query(playersCollectionRef()), (snapshot) => {
                    const playersData = {};
                    snapshot.forEach(doc => {
                        playersData[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    appState.players = playersData;
                    renderScoreboard();
                });

                const unsubFeed = onSnapshot(query(activityFeedCollectionRef(), orderBy("timestamp", "desc"), limit(5)), (snapshot) => {
                    appState.activityFeed = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderActivityFeed();
                });

                appState.unsubscribers.push(unsubPlayers, unsubFeed);
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appState.userId = user.uid;
                    setupFirestoreListeners();
                } else {
                    try { await signInAnonymously(auth); } catch(e) { console.error("Erro no login an√¥nimo:", e); }
                }
            });

            // EVENT LISTENERS
            ui.adminFab.addPlayerBtn.addEventListener('click', addNovoJogador);

            // Listener para o modo partida que estava comentado
            ui.gameMode.startBtn.addEventListener('click', startGame);

            // Adicione estes novos listeners:
            ui.gameMode.launchScoreBtn.addEventListener('click', launchScore);
            ui.gameMode.undoBtn.addEventListener('click', undoRound);
            ui.gameMode.endBtn.addEventListener('click', () => endGame(false)); // a confirma√ß√£o √© interna
            ui.gameMode.backToScoreboard_GameOverBtn.addEventListener('click', () => {
                switchView('view-scoreboard');
            });
            ui.gameMode.newGameBtn.addEventListener('click', () => { resetGameState(); switchView('view-game-table'); });

            ui.adminFab.button.addEventListener('click', toggleAdminPanel);
            ui.adminFab.activateBtn.addEventListener('click', activateAdminMode);
            ui.adminFab.keyInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    activateAdminMode();
                }
            });
            ui.adminFab.addPlayerBtn.addEventListener('click', addNovoJogador);

            ui.gameMode.goToBtn.addEventListener('click', () => { resetGameState(); switchView('view-game-table'); });
            ui.gameMode.backBtn.addEventListener('click', () => endGame(false));
            ui.gameMode.modeButtons.forEach(btn => btn.addEventListener('click', () => { if (!appState.gameState.activeGame) { appState.gameState.gameMode = btn.dataset.mode; updateGameModeUI(); }}));
            ui.gameMode.raioCheckbox.addEventListener('change', (e) => { if (!appState.gameState.activeGame) appState.gameState.isRaioMatch = e.target.checked; });
             // ui.gameMode.startBtn.addEventListener('click', startGame); // startGame precisa ser definida

            ui.playersListDiv.addEventListener('click', e => {
                const target = e.target.closest('.player-name-clickable');
                if (target) openPlayerDetailsModal(target.dataset.playerId);
            });

            ui.modal.container.addEventListener('click', e => {
                if (e.target.id === 'modalContainer' || e.target.closest('#modal-close-btn') || e.target.id === 'modal-cancel-btn') closeModal();
                // const playerBtn = e.target.closest('.player-select-btn');
                // if (playerBtn) selectPlayer(playerBtn.dataset.playerId);
                // L√≥gica de sele√ß√£o de jogador para os slots (AGORA MAIS SEGURA)
                const playerBtn = e.target.closest('.player-select-btn');
                // S√ì CHAMA O selectPlayer SE UM JOGO N√ÉO ESTIVER EM ANDAMENTO
                if (playerBtn && !appState.gameState.activeGame) {
                    selectPlayer(playerBtn.dataset.playerId);
                }
            });



        </script>
    </body>
    </html>

