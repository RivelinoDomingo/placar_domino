<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placar do Domin√≥ v2.0 (Integrado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .font-condensed { font-family: 'Roboto Condensed', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }

        .admin-fab-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; }
        .admin-fab { width: 60px; height: 60px; border-radius: 50%; background-color: #1f2937; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .admin-fab:hover { transform: scale(1.1); background-color: #374151; }
        .admin-fab.active { transform: rotate(45deg); }
        .admin-actions { position: absolute; bottom: 80px; right: 0; background-color: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); padding: 1.5rem; width: 300px; transform-origin: bottom right; transform: scale(0.9) translateY(10px); opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .admin-actions.active { transform: scale(1) translateY(0); opacity: 1; visibility: visible; }

        .achievement-icon { font-size: 1.5rem; filter: grayscale(80%); opacity: 0.4; transition: all 0.3s; }
        .achievement-icon.unlocked { filter: grayscale(0%); opacity: 1; }

        .player-name-clickable { cursor: pointer; transition: color 0.2s; }
        .player-name-clickable:hover { color: #2563eb; }

        .mesa-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; grid-template-rows: 1fr 2fr 1fr; grid-template-areas: ". top ." "left middle right" ". bottom ."; aspect-ratio: 1.5 / 1; width: 100%; max-width: 800px; }
        .player-slot-top { grid-area: top; }
        .player-slot-left { grid-area: left; }
        .player-slot-right { grid-area: right; }
        .player-slot-bottom { grid-area: bottom; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .point-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s ease; }
        .team-legend { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">

        <div id="view-scoreboard" class="view active fade-in">
            <div class="text-center mb-8"><h1 class="text-4xl font-bold font-condensed tracking-wider">PLACAR DO DOMIN√ì</h1></div>
            <div class="flex justify-center mb-12"><button id="btnGoToGameMode" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105"><span class="text-2xl mr-3">üÄÑ</span> Iniciar Modo Partida</button></div>
            <div id="playersList" class="space-y-3"><div class="text-center text-gray-500 p-8">Carregando placar...</div></div>
            <div class="mt-10"><h2 class="text-xl font-bold text-gray-700 mb-3">√öltimas Atividades</h2><div id="activityFeed" class="space-y-2 bg-white p-4 rounded-xl shadow-sm"><p class="text-gray-500 text-center">Carregando atividades...</p></div></div>
        </div>

        <div id="view-game-table" class="view fade-in">
            <div class="flex justify-between items-center mb-6">
                <button id="btnBackToScoreboard" class="text-gray-500 hover:text-gray-800 transition">‚Üê Voltar ao Placar</button>
                <div class="text-center"><h2 class="text-3xl font-bold font-condensed">MODO PARTIDA</h2><p id="gameStatusText" class="text-gray-500">Selecione os jogadores para come√ßar</p></div>
                <div class="w-24"></div>
            </div>
            <div id="game-type-selector" class="flex justify-center gap-4 mb-4"><button data-mode="individual" class="gameModeBtn font-semibold py-2 px-4 rounded-lg shadow">Individual</button><button data-mode="duplas" class="gameModeBtn font-semibold py-2 px-4 rounded-lg">Duplas</button></div>
            <div id="raio-mode-selector" class="flex justify-center items-center gap-2 mb-6"><input type="checkbox" id="raioModeCheckbox" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer"><label for="raioModeCheckbox" class="font-semibold text-gray-700 cursor-pointer select-none">Partida de Raio ‚ö°Ô∏è</label></div>
            <div class="bg-green-800 border-8 border-yellow-800/50 rounded-2xl shadow-2xl p-4 sm:p-8 mesa-grid mx-auto">
                <div class="flex items-center justify-center player-slot-top"><div id="slot-1" class="player-slot flex flex-col items-center"></div></div>
                <div class="flex items-center justify-center player-slot-left"><div id="slot-4" class="player-slot flex flex-col items-center"></div></div>
                <div class="bg-green-700/80 rounded-full flex items-center justify-center"><span class="text-5xl text-white/50 font-condensed">üÄÑ</span></div>
                <div class="flex items-center justify-center player-slot-right"><div id="slot-2" class="player-slot flex flex-col items-center"></div></div>
                <div class="flex items-center justify-center player-slot-bottom"><div id="slot-3" class="player-slot flex flex-col items-center"></div></div>
            </div>
            <div class="mt-8 text-center space-y-4">
                <button id="btnStartGame" class="bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-not-allowed" disabled>Iniciar Jogo</button>
                <div id="activeGameButtons" class="hidden flex-wrap justify-center gap-4"><button id="btnLaunchScore" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Lan√ßar Ponto</button><button id="btnUndoRound" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Desfazer</button><button id="btnEndGame" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition">Encerrar Partida</button></div>
            </div>
        </div>

        <div id="view-game-over" class="view fade-in text-center">
             <h2 class="text-2xl text-gray-600">Fim de Jogo</h2>
            <p id="gameOverWinnerText" class="text-5xl font-bold font-condensed my-4 text-blue-600"></p>
            <p id="gameOverScoreText" class="text-xl text-gray-500 mb-8"></p>
            <div class="flex justify-center gap-4 flex-wrap">
                 <button id="btnShareWhatsapp" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-600 transition flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg> Compartilhar</button>
                <button id="btnNewGame" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition">üÄÑ Nova Partida</button>
            </div>
        </div>
    </div>

    <!-- Admin FAB -->
    <div class="admin-fab-container"><div id="adminActionsPanel" class="admin-actions"><h3 class="font-bold text-lg mb-4 text-gray-800">Painel do Administrador</h3><div id="adminLoginView"><p class="text-sm text-gray-600 mb-2">Insira a senha para gerenciar.</p><input type="password" id="adminKeyInput" placeholder="Senha de Admin" class="w-full border-gray-300 rounded-md shadow-sm p-2"><button id="activateAdminBtn" class="w-full mt-3 bg-blue-600 text-white font-semibold py-2 rounded-md hover:bg-blue-700 transition">Ativar</button></div><div id="adminControlsView" class="hidden space-y-3"><button id="addPlayerBtn_fab" class="w-full bg-green-500 text-white font-semibold py-2 rounded-md hover:bg-green-600 transition">Adicionar Novo Jogador</button><button id="resetScoresBtn_fab" class="w-full bg-red-600 text-white font-semibold py-2 rounded-md hover:bg-red-700 transition">Redefinir Placar Geral</button><p id="adminStatus" class="text-center text-sm text-green-600 font-semibold pt-2">Modo Admin Ativado</p></div></div><div id="adminFabButton" class="admin-fab"><svg id="fabIconDefault" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg><svg id="fabIconClose" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="hidden"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div>

    <!-- Modal Gen√©rico -->
    <div id="modalContainer" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50"><div id="modalContent" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md m-auto"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =======================================================
        // CONFIGURA√á√ÉO E ESTADO INICIAL
        // =======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBqpkxcl0GkBBHVO8Nxk7UpYd00H4Frklc",
            authDomain: "placar-domino.firebaseapp.com",
            projectId: "placar-domino",
            storageBucket: "placar-domino.firebasestorage.app",
            messagingSenderId: "187178310074",
            appId: "1:187178310074:web:5f56292dea8dc776532583",
            measurementId: "G-BL3W42DJ3M"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const ADMIN_KEY = 'Domino25';
        const POINTS_TO_COMPLETE_RAIO = 4;
        const appIdentifier = firebaseConfig.appId;

        let appState = {
            players: {},
            activityFeed: [],
            isAdminMode: false,
            userId: null,
            gameState: {}
        };

        // Fun√ß√µes de refer√™ncia ao Firestore
        const playersCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/players`);
        const activityFeedCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/events`);
        const matchesCollectionRef = () => collection(db, `artifacts/${appIdentifier}/public/data/partidas`);

        // SELETORES DE UI (agrupados para organiza√ß√£o)
        const ui = {
            views: document.querySelectorAll('.view'),
            playersListDiv: document.getElementById('playersList'),
            activityFeedDiv: document.getElementById('activityFeed'),
            adminFab: { button: document.getElementById('adminFabButton'), panel: document.getElementById('adminActionsPanel'), defaultIcon: document.getElementById('fabIconDefault'), closeIcon: document.getElementById('fabIconClose'), loginView: document.getElementById('adminLoginView'), controlsView: document.getElementById('adminControlsView'), keyInput: document.getElementById('adminKeyInput'), activateBtn: document.getElementById('activateAdminBtn'), addPlayerBtn: document.getElementById('addPlayerBtn_fab'), resetBtn: document.getElementById('resetScoresBtn_fab')},
            modal: { container: document.getElementById('modalContainer'), content: document.getElementById('modalContent')},
            gameMode: { goToBtn: document.getElementById('btnGoToGameMode'), backBtn: document.getElementById('btnBackToScoreboard'), modeButtons: document.querySelectorAll('gameModeBtn'), raioCheckbox: document.getElementById('raioModeCheckbox'), startBtn: document.getElementById('btnStartGame'), activeButtons: document.getElementById('activeGameButtons'), launchScoreBtn: document.getElementById('btnLaunchScore'), undoBtn: document.getElementById('btnUndoRound'), endBtn: document.getElementById('btnEndGame'), newGameBtn: document.getElementById('btnNewGame'), shareBtn: document.getElementById('btnShareWhatsapp'), statusText: document.getElementById('gameStatusText'), gameOver: { winnerText: document.getElementById('gameOverWinnerText'), scoreText: document.getElementById('gameOverScoreText')}}
        };

        // =======================================================
        // FUN√á√ïES PRINCIPAIS DE RENDERIZA√á√ÉO
        // =======================================================
        function switchView(viewId) { ui.views.forEach(v => v.classList.toggle('active', v.id === viewId)); }

        function renderScoreboard() {
            const players = Object.values(appState.players);
            const seriesOrder = ['A', 'B', 'C', 'D', 'Amador'];

            players.sort((a, b) => {
                const seriesIndexA = seriesOrder.indexOf(a.series || 'Amador');
                const seriesIndexB = seriesOrder.indexOf(b.series || 'Amador');
                if (seriesIndexA !== seriesIndexB) return seriesIndexA - seriesIndexB;
                if ((b.raios || 0) !== (a.raios || 0)) return (b.raios || 0) - (a.raios || 0);
                if ((b.vitorias || 0) !== (a.vitorias || 0)) return (b.vitorias || 0) - (a.vitorias || 0);
                return (a.lambretas || 0) - (b.lambretas || 0);
            });

            ui.playersListDiv.innerHTML = players.map(player => `
                <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                    <div><span class="font-bold text-lg player-name-clickable" data-player-id="${player.id}">${player.name}</span><span class="text-sm text-gray-500 ml-2">(S√©rie ${player.series})</span></div>
                    <div class="text-right"><div class="font-semibold text-blue-600">Vit√≥rias: ${player.vitorias || 0}</div><div class="font-semibold text-yellow-600">Raios: ${player.raios || 0}</div></div>
                </div>`).join('');
        }
        function renderPlayers() {
            ui.playersListDiv.innerHTML = Object.values(allPlayers).sort((a, b) => a.name.localeCompare(b.name)).map(player => `
                <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                    <div><span class="font-bold text-lg player-name-clickable" data-player-id="${player.id}">${player.name}</span><span class="text-sm text-gray-500 ml-2">(S√©rie ${player.series})</span></div>
                    <div class="text-right"><div class="font-semibold text-blue-600">Raios: ${player.raios}</div><div class="font-semibold text-red-600">Lambretas: ${player.lambretas}</div></div>
                </div>`).join('');
        }
        function renderActivityFeed() {
            activityFeedDiv.innerHTML = activityFeedData.length === 0 ? '<p class="text-gray-500 text-center">Nenhuma atividade recente.</p>' :
                activityFeedData.map(item => {
                    let icon = 'üí¨';
                    if (item.type === 'promotion') icon = '‚ñ≤';
                    else if (item.type === 'demotion') icon = '‚ñº';
                    else if (item.type === 'achievement') icon = '‚≠ê';
                    const color = item.type === 'promotion' ? 'green' : (item.type === 'demotion' ? 'red' : 'yellow');
                    return `<div class="p-3 rounded-lg flex items-center gap-3"><span class="text-${color}-500">${icon}</span><div><p class="text-gray-800"><span class="font-semibold">${item.player}</span> ${item.text}</p><p class="text-xs text-gray-400">${item.timestamp.toLocaleString('pt-BR')}</p></div></div>`;
                }).join('');
        }
        function openModal(contentHTML) {
            modalContent.innerHTML = contentHTML;
            modalContainer.style.display = 'flex';
        }
        function closeModal() {
            modalContainer.style.display = 'none';
        }

        // =======================================================
        // FUN√á√ïES DO MODO PARTIDA (COM INTEGRA√á√ÉO FIREBASE)
        // =======================================================

        function openPlayerDetailsModal(playerId) {
            const player = allPlayers[playerId];
            const achievements = {
                primeiro_rei: { icon: 'üëë', name: 'Primeiro Rei' },
                imbativel: { icon: 'üî•', name: 'Imbat√≠vel' },
                azarao: { icon: 'üöë', name: 'Azar√£o' },
            };
            let achievementsHTML = Object.keys(achievements).map(key => {
                const ach = achievements[key];
                const unlocked = player.conquistas.includes(key);
                return `<div class="text-center p-2 rounded-lg ${unlocked ? 'bg-yellow-100' : 'bg-gray-100'}"><span class="achievement-icon ${unlocked ? 'unlocked' : ''}">${ach.icon}</span><p class="text-xs font-semibold mt-1 ${unlocked ? 'text-yellow-800' : 'text-gray-500'}">${ach.name}</p></div>`;
            }).join('');
            let adminControlsHTML = isAdminMode ? `<hr class="my-6"><div class="space-y-3"><button class="w-full bg-blue-500 text-white font-semibold py-2 rounded-md">Renomear</button><button class="w-full bg-red-600 text-white font-semibold py-2 rounded-md">Deletar</button></div>` : '';
            const modalHTML = `<div class="flex justify-between items-start"><div><h3 class="text-2xl font-bold">${player.name}</h3><p class="text-gray-600">S√©rie ${player.series}</p></div><button id="modal-close-btn" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button></div><div class="mt-6"><h4 class="font-semibold mb-2">Estat√≠sticas</h4><div class="grid grid-cols-2 gap-4 text-center"><div class="bg-gray-50 p-3 rounded-lg"><p class="text-2xl font-bold">${player.vitorias}</p><p class="text-sm text-gray-500">Vit√≥rias</p></div><div class="bg-gray-50 p-3 rounded-lg"><p class="text-2xl font-bold">${player.derrotas}</p><p class="text-sm text-gray-500">Derrotas</p></div></div></div><div class="mt-6"><h4 class="font-semibold mb-2">Conquistas</h4><div class="grid grid-cols-3 gap-2">${achievementsHTML}</div></div>${adminControlsHTML}`;
            openModal(modalHTML);
        }
        function createInitialGameState() {
            return {
                currentView: 'view-game-table', gameMode: 'individual', isRaioMatch: false,
                selectedSlots: { 1: null, 2: null, 3: null, 4: null }, activeGame: null, targetSlot: null
            };
        }
        function resetGameState() {
            gameState = createInitialGameState();
            document.getElementById('gameStatusText').textContent = 'Selecione os jogadores para come√ßar';
            btnStartGame.style.display = 'block';
            activeGameButtons.style.display = 'none';
            document.getElementById('game-type-selector').style.display = 'flex';
            document.getElementById('raio-mode-selector').style.display = 'flex';
            raioModeCheckbox.checked = false;
            updateGameModeUI();
        }
        function updateGameModeUI() {
            gameModeButtons.forEach(btn => btn.className = `gameModeBtn font-semibold py-2 px-4 rounded-lg ${btn.dataset.mode === gameState.gameMode ? 'shadow bg-blue-500 text-white' : 'bg-white text-gray-500'}`);
            resetPlayerSlots();
        }
        function resetPlayerSlots() {
            gameState.selectedSlots = { 1: null, 2: null, 3: null, 4: null };
            renderAllSlots();
        }
        function renderAllSlots() {
            document.querySelectorAll('.player-slot').forEach(slot => renderPlayerSlot(slot.id.split('-')[1]));
            checkStartGameCondition();
        }
        function openPlayerSelectionModal(slotId) {
            if (gameState.activeGame) return;
            gameState.targetSlot = slotId;
            const availablePlayers = Object.values(allPlayers).filter(p => !Object.values(gameState.selectedSlots).includes(p.id));
            const modalHTML = `<h3 class="text-2xl font-bold mb-4">Selecione um Jogador</h3><div class="space-y-2 max-h-64 overflow-y-auto">${availablePlayers.map(p => `<button class="w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition player-select-btn" data-player-id="${p.id}">${p.name}</button>`).join('')}</div><button id="modal-cancel-btn" class="mt-6 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full">Cancelar</button>`;
            openModal(modalHTML);
        }
        function selectPlayer(playerId) {
            const currentSlotOfPlayer = Object.keys(gameState.selectedSlots).find(key => gameState.selectedSlots[key] === playerId);
            if (currentSlotOfPlayer) gameState.selectedSlots[currentSlotOfPlayer] = null;
            gameState.selectedSlots[gameState.targetSlot] = playerId;
            closeModal();
            renderAllSlots();
        }
        function checkStartGameCondition() {
            const selectedCount = Object.values(gameState.selectedSlots).filter(Boolean).length;
            const canStart = (gameState.gameMode === 'duplas') ? (selectedCount === 4) : (selectedCount >= 2);
            btnStartGame.disabled = !canStart;
            btnStartGame.className = canStart ? 'bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition' : 'bg-gray-400 text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-not-allowed';
        }
        async function startGame() {
            const selectedPlayerIds = Object.values(appState.gameState.selectedSlots).filter(Boolean);
            const gameData = {
                status: 'em_andamento',
                mode: appState.gameState.gameMode,
                isRaioMatch: appState.gameState.isRaioMatch,
                jogadores: { ...appState.gameState.selectedSlots },
                times: {},
                placarAtual: {},
                historicoRodadas: [],
                dataCriacao: serverTimestamp()
            };

            if (gameData.mode === 'duplas') {
                gameData.times = { timeA: [gameData.jogadores[2], gameData.jogadores[4]], timeB: [gameData.jogadores[1], gameData.jogadores[3]] };
                gameData.placarAtual = { timeA: { pontos: 0, raios: 0 }, timeB: { pontos: 0, raios: 0 } };
            } else {
                selectedPlayerIds.forEach(pId => { gameData.times[pId] = [pId]; gameData.placarAtual[pId] = { pontos: 0, raios: 0 }; });
            }

            try {
                const docRef = await addDoc(matchesCollectionRef(), gameData);
                appState.gameState.activeGameId = docRef.id;
                appState.gameState.activeGame = gameData; // Armazena localmente para evitar reads
                // Inicia o ouvinte para esta partida espec√≠fica (opcional, mas bom para multi-dispositivo)
                // listenToActiveMatch(docRef.id);

                // Atualiza UI
                ui.gameMode.statusText.textContent = gameData.isRaioMatch ? 'Partida de Raio em andamento!' : 'Partida em andamento!';
                ui.gameMode.startBtn.style.display = 'none';
                ui.gameMode.activeButtons.style.display = 'flex';
                document.getElementById('game-type-selector').style.display = 'none';
                document.getElementById('raio-mode-selector').style.display = 'none';
            } catch (error) {
                console.error("Erro ao iniciar a partida:", error);
                alert("N√£o foi poss√≠vel iniciar a partida. Tente novamente.");
            }
        }
        function openScoreRoundModal() {
            let teamsOrPlayers, teamIds;
            if (gameState.gameMode === 'duplas') {
                const playersA = gameState.activeGame.times.timeA.map(pId => allPlayers[pId].name).join(' & ');
                const playersB = gameState.activeGame.times.timeB.map(pId => allPlayers[pId].name).join(' & ');
                teamsOrPlayers = [`Time A (${playersA})`, `Time B (${playersB})`];
                teamIds = ['timeA', 'timeB'];
            } else {
                const activePlayers = Object.values(gameState.activeGame.jogadores).filter(Boolean);
                teamsOrPlayers = activePlayers.map(pId => allPlayers[pId].name);
                teamIds = activePlayers;
            }
            const modalHTML = `<h3 class="text-2xl font-bold mb-4">Quem venceu a rodada?</h3><div class="space-y-3">${teamsOrPlayers.map((name, index) => `<button class="w-full text-center p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition font-semibold score-round-btn" data-winner-id="${teamIds[index]}">${name}</button>`).join('')}</div><button id="modal-cancel-btn" class="mt-6 bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full">Cancelar</button>`;
            openModal(modalHTML);
        }
        async function scoreRound(winnerId) {
            if (!appState.gameState.activeGameId) return;
            const matchDocRef = doc(matchesCollectionRef(), appState.gameState.activeGameId);
            const game = appState.gameState.activeGame;

            const newRound = { vencedor: winnerId, timestamp: new Date() };
            game.historicoRodadas.push(newRound);

            const placar = game.placarAtual;

            // L√≥gica de pontua√ß√£o
            if (game.isRaioMatch) {
                placar[winnerId].raios++;
            } else {
                placar[winnerId].pontos++;
                if (placar[winnerId].pontos >= POINTS_TO_COMPLETE_RAIO) {
                    placar[winnerId].raios++;

                    let losersHadZero = true;
                    Object.keys(placar).forEach(id => {
                        if (id !== winnerId && placar[id].pontos > 0) losersHadZero = false;
                        placar[id].pontos = 0; // Zera para todos
                    });

                    await updatePlayerStatsAfterRaio(winnerId, losersHadZero);
                }
            }

            try {
                await updateDoc(matchDocRef, {
                    placarAtual: placar,
                    historicoRodadas: game.historicoRodadas
                });
                // A UI ser√° atualizada pelo ouvinte de partida (se implementado)
                // ou manualmente:
                updateScoreboardUI();
                closeModal();
            } catch (error) {
                console.error("Erro ao lan√ßar ponto:", error);
                game.historicoRodadas.pop(); // Reverte a l√≥gica local se falhar
            }
        }
        function undoLastRound() {
            if (!gameState.activeGame || gameState.activeGame.historicoRodadas.length === 0) {
                alert('Nenhuma rodada para desfazer.');
                return;
            }
            const lastRound = gameState.activeGame.historicoRodadas.pop();
            const placar = gameState.activeGame.placarAtual;
            const winnerId = lastRound.vencedor;

            // L√≥gica de Desfazer Simplificada
            if (gameState.activeGame.isRaioMatch) {
                if (placar[winnerId].raios > 0) placar[winnerId].raios--;
            } else {
                if (placar[winnerId].pontos > 0) {
                    placar[winnerId].pontos--;
                } else if (placar[winnerId].raios > 0) {
                    placar[winnerId].raios--;
                    placar[winnerId].pontos = POINTS_TO_COMPLETE_RAIO - 1;
                    // Nota: A l√≥gica de reverter stats (raios/lambretas) n√£o √© implementada no undo para simplicidade.
                }
            }
            updateScoreboardUI();
        }
        function endGame() {
            if (!gameState.activeGame) return;
            let winnerText, scoreText, rawWinnerText;
            const placar = gameState.activeGame.placarAtual;
            const getFinalScore = (score) => score.raios * POINTS_TO_COMPLETE_RAIO + score.pontos;

            if (gameState.gameMode === 'duplas') {
                const scoreA = getFinalScore(placar.timeA);
                const scoreB = getFinalScore(placar.timeB);
                const winner = scoreA > scoreB ? 'timeA' : (scoreB > scoreA ? 'timeB' : null);
                if (winner) {
                    const winnerPlayers = gameState.activeGame.times[winner].map(pId => allPlayers[pId].name).join(' e ');
                    winnerText = `Vit√≥ria do ${winner.replace('time','Time ')}!`;
                    scoreText = `(${winnerPlayers}) - Placar Final: ${scoreA} a ${scoreB}`;
                    rawWinnerText = `O time de ${winnerPlayers}`;
                } else {
                    winnerText = "Empate!";
                    scoreText = `Placar Final: Time A ${scoreA} - ${scoreB} Time B`;
                    rawWinnerText = "A partida terminou empatada";
                }
            } else {
                const scores = Object.entries(placar).map(([id, score]) => ({ id, score: getFinalScore(score) }));
                scores.sort((a,b) => b.score - a.score);
                const winnerId = scores[0].id;
                const winnerPlayer = allPlayers[winnerId];
                winnerText = `Vit√≥ria de ${winnerPlayer.name}!`;
                scoreText = `Pontua√ß√£o Final: ${scores[0].score} pontos`;
                rawWinnerText = `O jogador ${winnerPlayer.name}`;
            }

            document.getElementById('gameOverWinnerText').textContent = winnerText;
            document.getElementById('gameOverScoreText').textContent = scoreText;
            const shareMessage = encodeURIComponent(`üèÜ Vit√≥ria no Placar do Domin√≥! ${rawWinnerText} acaba de vencer a partida. #PlacarDoDomino`);
            btnShareWhatsapp.onclick = () => window.open(`https://api.whatsapp.com/send?text=${shareMessage}`, '_blank');
            switchView('view-game-over');
        }
        function updatePlayerStats(winnerId, losersHadZero) {
                const winnerTeam = gameState.activeGame.times[winnerId];
                winnerTeam.forEach(pId => allPlayers[pId].raios++);

                if(losersHadZero) {
                Object.keys(gameState.activeGame.times).forEach(teamId => {
                    if(teamId !== winnerId) {
                        gameState.activeGame.times[teamId].forEach(pId => allPlayers[pId].lambretas++);
                    }
                });
                }
                renderPlayers();
        }
        function updateScoreboardUI() {
            if (!gameState.activeGame) return;
            const isRaio = gameState.activeGame.isRaioMatch;
            const getScoreHTML = (score, color = 'yellow') => {
                const raios = score.raios;
                const pontos = isRaio ? 0 : score.pontos;
                const raioHTML = Array(raios).fill(`<span class="text-${color}-400">‚ö°Ô∏è</span>`).join('');
                const pontoHTML = Array(pontos).fill(`<div class="point-dot bg-${color}-500"></div>`).join('');
                return `${raioHTML} ${pontoHTML}`;
            };
            if (gameState.gameMode === 'duplas') {
                ['timeA', 'timeB'].forEach(teamId => {
                    const score = gameState.activeGame.placarAtual[teamId];
                    const teamColor = teamId === 'timeA' ? 'blue' : 'red';
                    gameState.activeGame.times[teamId].forEach(pId => {
                        const slotId = Object.keys(gameState.activeGame.jogadores).find(key => gameState.activeGame.jogadores[key] === pId);
                        const scoreDiv = document.getElementById(`score-${slotId}`);
                        if(scoreDiv) scoreDiv.innerHTML = getScoreHTML(score, teamColor);
                    });
                });
            } else {
                    Object.keys(gameState.activeGame.placarAtual).forEach(playerId => {
                    const score = gameState.activeGame.placarAtual[playerId];
                    const slotId = Object.keys(gameState.activeGame.jogadores).find(key => gameState.activeGame.jogadores[key] === playerId);
                    const scoreDiv = document.getElementById(`score-${slotId}`);
                    if(scoreDiv) scoreDiv.innerHTML = getScoreHTML(score, 'yellow');
                    });
            }
        }
        async function updatePlayerStatsAfterRaio(winnerId, losersHadZero) {
            const batch = writeBatch(db);
            const game = appState.gameState.activeGame;
            const winnerTeamPlayerIds = game.times[winnerId];

            const vitoriasToAdd = game.isRaioMatch ? 4 : 1;

            winnerTeamPlayerIds.forEach(pId => {
                const playerRef = doc(playersCollectionRef(), pId);
                batch.update(playerRef, {
                    raios: (appState.players[pId].raios || 0) + 1,
                    vitorias: (appState.players[pId].vitorias || 0) + vitoriasToAdd
                });
            });

            if (losersHadZero) {
                Object.keys(game.times).forEach(teamId => {
                    if (teamId !== winnerId) {
                        game.times[teamId].forEach(pId => {
                            const playerRef = doc(playersCollectionRef(), pId);
                            batch.update(playerRef, {
                                lambretas: (appState.players[pId].lambretas || 0) + 1
                            });
                        });
                    }
                });
            }

            try {
                await batch.commit();
                console.log("Estat√≠sticas dos jogadores atualizadas ap√≥s o Raio.");
            } catch (error) {
                console.error("Erro ao atualizar estat√≠sticas:", error);
            }
        }

        // =======================================================
        // L√ìGICA DO FIREBASE E INICIALIZA√á√ÉO
        // =======================================================

        function setupFirestoreListeners() {
            onSnapshot(query(playersCollectionRef()), (snapshot) => {
                const playersData = {};
                snapshot.forEach(doc => {
                    playersData[doc.id] = { id: doc.id, ...doc.data() };
                });
                appState.players = playersData;
                renderScoreboard();
            });

            onSnapshot(query(activityFeedCollectionRef(), orderBy("timestamp", "desc"), limit(5)), (snapshot) => {
                appState.activityFeed = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderActivityFeed();
            });
        }

        // LISTENERS
        ui.gameMode.goToBtn.addEventListener('click', () => switchView('view-scoreboard'));
        ui.gameMode.backBtn.addEventListener('click', () => { if (!gameState.activeGame) { gameState.gameMode = btn.dataset.mode; updateGameModeUI(); }});
        ui.gameMode.raioCheckbox.addEventListener('change', (e) => { if (!gameState.activeGame) gameState.isRaioMatch = e.target.checked; });
        ui.gameMode.startBtn.addEventListener('click', startGame);
        ui.gameMode.launchScoreBtn.addEventListener('click', openScoreRoundModal);
        ui.gameMode.undoBtn.addEventListener('click', undoLastRound); // CORRE√á√ÉO: Listener adicionado
        ui.gameMode.endBtn.addEventListener('click', endGame);         // CORRE√á√ÉO: Listener adicionado
        ui.gameMode.newGameBtn.addEventListener('click', () => { resetGameState(); switchView('view-game-table'); });
        ui.playersListDiv.addEventListener('click', e => { const t = e.target.closest('.player-name-clickable'); if(t) openPlayerDetailsModal(t.dataset.playerId);});
        ui.modal.container.addEventListener('click', e => {
            if (e.target.id === 'modalContainer' || e.target.closest('#modal-close-btn') || e.target.id === 'modal-cancel-btn') closeModal();
            const playerBtn = e.target.closest('.player-select-btn');
            if (playerBtn) selectPlayer(playerBtn.dataset.playerId);
            const scoreBtn = e.target.closest('.score-round-btn');
            if (scoreBtn) scoreRound(scoreBtn.dataset.winnerId);
        });


        // INICIALIZA√á√ÉO
        renderPlayers();
        renderActivityFeed();
        updateGameModeUI();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                appState.userId = user.uid;
                setupFirestoreListeners();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch(e) {
                    console.error("Erro ao fazer login an√¥nimo:", e);
                }
            }
        });

    </script>
</body>
</html>
